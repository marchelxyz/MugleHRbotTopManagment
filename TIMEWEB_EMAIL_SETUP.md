# Настройка интеграции с почтовым ящиком Timeweb

## Описание

Интеграция позволяет автоматически отправлять email уведомления:
- **При регистрации пользователя** - администраторам приходит уведомление о новой заявке
- **При одобрении регистрации** - пользователю отправляются логин и пароль для входа в систему

## Требования

1. Почтовый ящик, созданный через Timeweb
2. Доступ к настройкам SMTP почтового ящика

## Настройка SMTP Timeweb

Согласно [документации Timeweb](https://timeweb.cloud/docs/mail/email-clients-configuration), для отправки email через SMTP используются следующие параметры:

- **SMTP сервер:** `smtp.timeweb.ru` (⚠️ **Важно:** используйте `.ru`, а не `.com`)
- **Порт:** `465` (SSL) или `587` (TLS)
- **Логин:** полный email адрес (например, `user@yourdomain.com`)
- **Пароль:** пароль от почтового ящика

## Настройка переменных окружения

Добавьте следующие переменные в файл `.env` в папке `backend/`:

```env
# Настройки SMTP Timeweb
SMTP_HOST=smtp.timeweb.ru
SMTP_PORT=465
SMTP_USERNAME=your-email@yourdomain.com
SMTP_PASSWORD=your_email_password
SMTP_USE_TLS=false

# Email адреса администраторов (через запятую)
ADMIN_EMAILS=admin1@example.com,admin2@example.com

# URL страницы входа в веб-приложение (опционально)
# Это полный URL вашего фронтенда (где пользователи открывают приложение)
# Примеры:
# - Если фронтенд на Vercel: https://your-project.vercel.app
# - Если есть свой домен: https://yourdomain.com
# - Если фронтенд на Railway: https://your-frontend.up.railway.app
WEB_APP_LOGIN_URL=https://your-app.com
```

### Описание переменных

- **SMTP_HOST** - SMTP сервер Timeweb (по умолчанию: `smtp.timeweb.ru`)
- **SMTP_PORT** - Порт SMTP (465 для SSL, 587 для TLS)
- **SMTP_USERNAME** - Полный email адрес от Timeweb
- **SMTP_PASSWORD** - Пароль от почтового ящика
- **SMTP_USE_TLS** - Использовать TLS (true для порта 587, false для порта 465)
- **ADMIN_EMAILS** - Список email адресов администраторов через запятую для получения уведомлений о регистрациях
- **WEB_APP_LOGIN_URL** - Полный URL вашего фронтенда (веб-приложения), где пользователи открывают приложение в браузере. Это может быть:
  - URL проекта на Vercel (например: `https://your-project.vercel.app`)
  - Ваш собственный домен (например: `https://yourdomain.com`)
  - URL проекта на Railway (например: `https://your-frontend.up.railway.app`)
  
  ⚠️ **Важно:** Это URL фронтенда (где пользователи видят страницу входа), а не бэкенда. Если не указать, письмо отправится без ссылки для входа.

## Установка зависимостей

Установите библиотеку для отправки email:

```bash
cd backend
pip install -r requirements.txt
```

Библиотека `aiosmtplib==3.0.1` уже добавлена в `requirements.txt`.

## Применение миграции базы данных

Добавьте поле `email` в таблицу `users`:

```bash
# Выполните SQL миграцию
psql -d your_database -f backend/migrations/007_add_email_field.sql
```

Или выполните SQL вручную:

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS email VARCHAR(255) NULL;
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email) WHERE email IS NOT NULL;
```

## Как это работает

### 1. Регистрация пользователя

Когда пользователь регистрируется через веб-интерфейс:

1. Пользователь заполняет форму регистрации, включая **email** (обязательное поле для веб-регистрации)
2. Заявка сохраняется в базе данных со статусом `pending`
3. Администраторам отправляется:
   - Уведомление в Telegram (если настроено)
   - Email уведомление на адреса из `ADMIN_EMAILS`

### 2. Одобрение регистрации

Когда администратор одобряет регистрацию веб-пользователя:

1. Система автоматически генерирует логин и пароль (если их еще нет)
2. Пользователю отправляется email с:
   - Приветственным сообщением
   - Логином и паролем для входа
   - Ссылкой на страницу входа (если указан `WEB_APP_LOGIN_URL`)
   - Рекомендацией изменить пароль после первого входа

## Проверка работы

### Тест отправки email

Для проверки работы email интеграции можно использовать следующий код в Python консоли:

```python
import asyncio
from backend.email_service import send_email

async def test_email():
    result = await send_email(
        to_email="test@example.com",
        subject="Тестовое письмо",
        body_html="<h1>Тест</h1><p>Это тестовое письмо.</p>",
        body_text="Тест\n\nЭто тестовое письмо."
    )
    print(f"Результат отправки: {result}")

asyncio.run(test_email())
```

## Устранение неполадок

### Письма не отправляются

1. **Проверьте настройки SMTP:**
   - Убедитесь, что `SMTP_USERNAME` и `SMTP_PASSWORD` указаны правильно
   - Проверьте, что порт соответствует типу соединения (465 для SSL, 587 для TLS)

2. **Проверьте логи:**
   - Ошибки отправки email логируются в консоль
   - Ищите сообщения с префиксом "FAILED to send email" или "Ошибка при отправке email"

3. **Проверьте настройки почтового ящика:**
   - Убедитесь, что почтовый ящик активен в панели Timeweb
   - Проверьте, что пароль указан правильно

4. **Проверьте firewall/безопасность:**
   - Убедитесь, что сервер может подключаться к `smtp.timeweb.ru` на портах 465 или 587
   - ⚠️ **Важно:** Используйте `smtp.timeweb.ru` (с `.ru`), а не `smtp.timeweb.com` (`.com` не разрешается DNS)

### Письма попадают в спам

- Убедитесь, что домен настроен правильно в Timeweb
- Проверьте SPF и DKIM записи для домена
- Используйте email адрес, соответствующий домену приложения

## Безопасность

⚠️ **Важно:**

1. **Никогда не коммитьте файл `.env`** в репозиторий
2. Храните пароли от почтовых ящиков в безопасном месте
3. Используйте отдельный почтовый ящик для рассылок (не личный)
4. Регулярно меняйте пароли от почтовых ящиков

## Дополнительная информация

- [Документация Timeweb по настройке почтовых клиентов](https://timeweb.cloud/docs/mail/email-clients-configuration)
- [Документация aiosmtplib](https://aiosmtplib.readthedocs.io/)
