# Инструкция по настройке автоматической отправки email через Unisender

## Что было сделано

1. ✅ Добавлено поле `email` в модель пользователя
2. ✅ Создана миграция базы данных для добавления колонки email
3. ✅ Добавлен email в форму регистрации
4. ✅ Создан сервис `email_service.py` для работы с Unisender API
5. ✅ Интегрирована автоматическая отправка email при одобрении регистрации

## Шаги для настройки

### 1. Регистрация в Unisender

1. Зайдите на сайт [Unisender.com](https://www.unisender.com/)
2. Зарегистрируйте аккаунт (бесплатный тариф: 100 писем/месяц)
3. После регистрации перейдите в раздел **"Настройки" → "API"**
4. Скопируйте ваш **API ключ**

### 2. Подтверждение email отправителя

1. В Unisender перейдите в **"Настройки" → "Отправители"**
2. Добавьте email адрес, с которого будут отправляться письма (например, `noreply@ваш-домен.ru`)
3. Подтвердите email адрес (Unisender отправит письмо с подтверждением)
4. После подтверждения этот email можно использовать как `UNISENDER_SENDER_EMAIL`

### 3. Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# Unisender настройки
UNISENDER_API_KEY=ваш_api_ключ_от_unisender
UNISENDER_SENDER_NAME=Система уведомлений
UNISENDER_SENDER_EMAIL=noreply@ваш-домен.ru
```

**Важно:**
- `UNISENDER_API_KEY` - ваш API ключ из раздела настроек Unisender
- `UNISENDER_SENDER_EMAIL` - email адрес, который вы подтвердили в Unisender (должен быть подтвержден!)
- `UNISENDER_SENDER_NAME` - имя отправителя (можно изменить на любое)

### 4. Применение миграции базы данных

Выполните миграцию для добавления поля email:

```bash
# Если у вас есть скрипт для запуска миграций
python backend/run_migrations.py

# Или выполните SQL напрямую в базе данных
psql -d ваша_база_данных -f backend/migrations/007_add_email_field.sql
```

### 5. Перезапуск приложения

После настройки переменных окружения перезапустите ваше приложение:

```bash
# Если используете systemd
sudo systemctl restart ваш-сервис

# Или просто перезапустите процесс
```

## Как это работает

1. **При регистрации:** Пользователь указывает свой email в форме регистрации
2. **При одобрении:** Когда администратор одобряет регистрацию через `/admin/users/{user_id}/approve`:
   - Система автоматически генерирует логин и пароль (если их еще нет)
   - Если у пользователя указан email, автоматически отправляется письмо с учетными данными
   - Письмо содержит логин, пароль и инструкции по входу

## Проверка работы

1. Зарегистрируйте тестового пользователя с email адресом
2. Одобрите регистрацию через админ-панель
3. Проверьте почту пользователя - должно прийти письмо с учетными данными
4. Проверьте логи приложения на наличие ошибок отправки

## Устранение проблем

### Письма не отправляются

1. **Проверьте логи приложения** - там будут детали ошибок
2. **Убедитесь, что API ключ правильный** - проверьте в Unisender
3. **Проверьте, что email отправителя подтвержден** - в разделе "Отправители"
4. **Убедитесь, что у пользователя указан email** - проверьте в базе данных

### Ошибка "email не подтвержден"

- Email адрес в `UNISENDER_SENDER_EMAIL` должен быть подтвержден в Unisender
- Перейдите в "Настройки → Отправители" и убедитесь, что статус "Подтвержден"

### Письма попадают в спам

- Убедитесь, что домен отправителя настроен правильно
- В Unisender можно настроить SPF и DKIM записи для домена (в платных тарифах)

## Лимиты Unisender

- **Бесплатный тариф:** 100 писем/месяц
- Для вашего объема (20-30 писем/неделю) этого более чем достаточно
- Если нужно больше, можно перейти на платный тариф от 990₽/месяц за 10,000 писем

## Дополнительная информация

- Документация Unisender API: https://www.unisender.com/ru/support/api/
- Шаблон письма можно изменить в файле `backend/email_service.py` в функции `send_registration_approval_email`
