# Интеграция с ВКонтакте для отправки сообщений

## Описание

Система теперь поддерживает отправку уведомлений и учетных данных пользователям через ВКонтакте вместо email. Это решает проблемы с отправкой email через Unisender на бесплатном тарифе.

## Настройка

### 1. Создание приложения VK

1. Перейдите на https://vk.com/apps?act=manage
2. Создайте новое приложение типа "Веб-сайт"
3. После создания приложения перейдите в "Настройки" → "Работа с API"
4. Скопируйте **Service Token** (сервисный ключ доступа) или создайте токен с правами `messages`

### 2. Получение VK ID пользователей

Для отправки сообщений пользователям необходимо знать их VK ID. Есть несколько способов:

#### Способ 1: Через VK API (если есть email)
```python
# Можно использовать метод users.get для получения ID по email
# Но это требует дополнительных прав доступа
```

#### Способ 2: Вручную через профиль пользователя
1. Откройте профиль пользователя в VK
2. В URL будет ID: `https://vk.com/id123456789` → ID = 123456789
3. Или используйте числовой ID из настроек профиля

#### Способ 3: Через форму регистрации
Добавьте поле для ввода VK ID в форму регистрации пользователей.

### 3. Настройка переменных окружения

Добавьте следующие переменные в файл `.env`:

```env
# Настройки VK API
VK_API_KEY=your_vk_service_token_here
VK_API_VERSION=5.131
VK_ADMIN_ID=123456789  # VK ID администратора для получения уведомлений о регистрациях
```

### 4. Применение миграции базы данных

Выполните миграцию для добавления поля `vk_id` в таблицу пользователей:

```bash
cd backend
python run_migrations.py
```

Или миграция будет применена автоматически при следующем запуске приложения.

## Использование

### Приоритет отправки

Система использует следующий приоритет при отправке уведомлений:

1. **VK** - если указан `vk_id` пользователя и настроен VK API
2. **Email** - если VK не настроен или не удалось отправить через VK

### Отправка учетных данных

При одобрении регистрации пользователя система автоматически:

1. Проверяет наличие `vk_id` у пользователя
2. Если `vk_id` указан и VK API настроен - отправляет сообщение через VK
3. Если VK не настроен или произошла ошибка - пытается отправить через email (fallback)

### Отправка уведомлений администратору

При регистрации нового пользователя через веб:

1. Если указан `VK_ADMIN_ID` - отправляется уведомление через VK
2. Иначе отправляется через email (если настроен Unisender)

## Добавление VK ID пользователям

### Через админ-панель

Добавьте возможность редактирования поля `vk_id` в админ-панели для существующих пользователей.

### Через API

```python
# Пример обновления VK ID пользователя
user.vk_id = 123456789
await db.commit()
```

### Через форму регистрации

Добавьте поле для ввода VK ID в форму регистрации пользователей.

## Ограничения VK API

- **Лимит сообщений**: VK API имеет ограничения на количество сообщений в день (зависит от типа токена)
- **Требуется подтверждение**: Для отправки сообщений пользователям, которые не добавили бота в друзья, может потребоваться подтверждение
- **Токен доступа**: Используйте Service Token или токен с правами `messages`

## Отладка

### Проверка настроек

Убедитесь, что в логах нет ошибок:
```
VK API не настроен. Пропускаем отправку сообщения.
```

### Проверка отправки

При успешной отправке в логах будет:
```
Сообщение успешно отправлено пользователю {vk_id}, message_id: {message_id}
```

При ошибке:
```
Ошибка отправки сообщения пользователю {vk_id}: {error_msg} (код: {error_code})
```

## Примеры ошибок VK API

- **901**: "Can't send messages to this user due to their privacy settings" - пользователь запретил получение сообщений
- **902**: "User not found" - пользователь с таким ID не найден
- **913**: "Message is too long" - сообщение превышает лимит длины

## Дополнительная информация

- [Документация VK API](https://dev.vk.com/method/messages.send)
- [Получение токена доступа](https://dev.vk.com/api/access-token/getting-started)
