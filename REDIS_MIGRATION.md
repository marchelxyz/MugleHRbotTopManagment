# Миграция кеширования с Telegram CloudStorage на Redis

## Проблема

Telegram CloudStorage может терять данные при выходе из приложения или при проблемах с соединением. Это приводило к потере кешированных данных (feed, market, leaderboard, banners) после перезапуска приложения.

## Решение

Реализовано серверное кеширование на базе Redis, которое:
- Гарантирует сохранность данных независимо от состояния Telegram WebApp
- Позволяет синхронизировать данные между устройствами пользователя
- Обеспечивает надежное хранение с настраиваемым TTL

## Что было сделано

### Backend

1. **Добавлены зависимости** (`backend/requirements.txt`):
   - `redis` - синхронный клиент Redis
   - `aioredis` - асинхронный клиент Redis для FastAPI

2. **Создан модуль Redis кеша** (`backend/redis_cache.py`):
   - Класс `RedisCache` для работы с кешем
   - Методы: `get`, `set`, `delete`, `clear_user_cache`, `exists`
   - Автоматическое определение TTL в зависимости от типа данных

3. **Добавлены настройки Redis** (`backend/config.py`):
   - `REDIS_HOST` - хост Redis (по умолчанию: localhost)
   - `REDIS_PORT` - порт Redis (по умолчанию: 6379)
   - `REDIS_DB` - номер базы данных (по умолчанию: 0)
   - `REDIS_PASSWORD` - пароль (опционально)
   - `REDIS_URL` - полный URL подключения (если указан, используется вместо отдельных параметров)

4. **Создан API роутер для кеша** (`backend/routers/cache.py`):
   - `GET /cache/{key}` - получение значения из кеша
   - `POST /cache/{key}` - установка значения в кеш
   - `DELETE /cache/{key}` - удаление значения из кеша
   - `DELETE /cache/` - очистка всего кеша пользователя

5. **Обновлено приложение** (`backend/app.py`):
   - Инициализация Redis при старте приложения
   - Корректное отключение при остановке
   - Подключен роутер кеша

### Frontend

1. **Добавлены API функции** (`frontend/src/api.js`):
   - `getCache(key)` - получение из кеша
   - `setCache(key, value, ttl)` - сохранение в кеш
   - `deleteCache(key)` - удаление из кеша
   - `clearAllCache()` - очистка всего кеша

2. **Обновлен модуль storage** (`frontend/src/storage.js`):
   - Заменен Telegram CloudStorage на Redis API
   - Реализован fallback на localStorage для случаев, когда Redis недоступен
   - Все функции кеширования теперь работают через Redis

3. **Обновлен App.jsx**:
   - Исправлено использование async/await для работы с асинхронным кешем

## Настройка

### Переменные окружения (.env)

```env
# Redis настройки
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# Или используйте полный URL:
# REDIS_URL=redis://localhost:6379/0
```

### Установка зависимостей

```bash
cd backend
pip install -r requirements.txt
```

### Запуск Redis

**Локально:**
```bash
redis-server
```

**Docker:**
```bash
docker run -d -p 6379:6379 redis:alpine
```

## Преимущества

1. **Надежность**: Данные сохраняются на сервере и не зависят от состояния клиента
2. **Синхронизация**: Данные доступны на всех устройствах пользователя
3. **Производительность**: Быстрый доступ к кешированным данным
4. **Гибкость**: Настраиваемый TTL для разных типов данных
5. **Отказоустойчивость**: Fallback на localStorage при недоступности Redis

## TTL по умолчанию

- `feed`, `market`, `banners`: 1 час (3600 секунд)
- `leaderboard`: 5 минут (300 секунд)
- `history`: 30 минут (1800 секунд)

## Переподключение после выхода из приложения

В `App.jsx` уже реализованы обработчики событий Telegram WebApp для переподключения:

- `viewportChanged` - при изменении видимости viewport
- `visibilityChanged` - при изменении видимости приложения
- `visibilitychange` (браузерное событие) - fallback для браузеров

При возврате приложения в активное состояние вызывается `tg.ready()` для переподключения к Telegram WebApp API.

## Миграция данных

Существующие данные в CloudStorage будут автоматически мигрированы при первом обращении:
1. При инициализации кеша сначала проверяется Redis
2. Если данных нет в Redis, используется fallback на localStorage
3. При следующем обновлении данных они сохраняются в Redis

## Откат

Если необходимо вернуться к CloudStorage:

1. В `frontend/src/storage.js` замените Redis API на CloudStorage
2. Удалите роутер кеша из `backend/app.py`
3. Удалите зависимости Redis из `requirements.txt`

Однако рекомендуется использовать Redis для надежности и производительности.
