import{r as n,j as e}from"./react-vendor-CTCOu_cH.js";import{ag as T,i as k}from"./index-DWD9sWeV.js";import{f as P}from"./nameFormatter-Cu470NoG.js";import{P as E}from"./PageLayout-BcvhvPkp.js";import"./vendor-62T33e3N.js";import"./lottie-vendor-CdbPF2lo.js";import"./date-vendor-BIBOd_sa.js";import"./chart-vendor-CqyaVfOQ.js";import"./axios-vendor-D5lHaTRS.js";const G="_backButton_1ubn5_5",A="_formGroup_1ubn5_7",D="_label_1ubn5_12",F="_input_1ubn5_20",M="_textarea_1ubn5_22",V="_textareaContainer_1ubn5_32",q="_messageHint_1ubn5_54",O="_messageHintText_1ubn5_68",Q="_charCounter_1ubn5_79",W="_submitButton_1ubn5_103",z="_error_1ubn5_123",J="_success_1ubn5_129",K="_balanceInfo_1ubn5_135",X="_searchContainer_1ubn5_162",Y="_searchResults_1ubn5_166",Z="_searchResultItem_1ubn5_181",ee="_userName_1ubn5_196",se="_userPosition_1ubn5_203",te="_noResults_1ubn5_208",ne="_loader_1ubn5_215",t={backButton:G,formGroup:A,label:D,input:F,textarea:M,textareaContainer:V,messageHint:q,messageHintText:O,charCounter:Q,submitButton:W,error:z,success:J,balanceInfo:K,searchContainer:X,searchResults:Y,searchResultItem:Z,userName:ee,userPosition:se,noResults:te,loader:ne};function ae({currentUser:d,onUserSelect:I}){const[l,_]=n.useState(""),[h,a]=n.useState([]),[f,b]=n.useState([]),[i,x]=n.useState(!1),[y,u]=n.useState(!1),[p,c]=n.useState(!1),m=n.useRef(null);n.useEffect(()=>{g()},[]),n.useEffect(()=>{if(l.trim()==="")b(h);else{const s=l.toLowerCase(),r=h.filter(o=>{var C,v,U,L;return((C=o.first_name)==null?void 0:C.toLowerCase().includes(s))||((v=o.last_name)==null?void 0:v.toLowerCase().includes(s))||((U=o.username)==null?void 0:U.toLowerCase().includes(s))||((L=o.phone_number)==null?void 0:L.toLowerCase().includes(s))||`${o.first_name} ${o.last_name}`.toLowerCase().includes(s)||o.username&&`@${o.username}`.toLowerCase().includes(s)});b(r)}},[l,h]);const g=async()=>{var s,r,o,C;x(!0);try{const v=((C=(o=(r=(s=window.Telegram)==null?void 0:s.WebApp)==null?void 0:r.initDataUnsafe)==null?void 0:o.user)==null?void 0:C.id)||null,L=(await k(v)).data.filter(w=>w.id!==d.id&&w.status!=="rejected").sort((w,B)=>{const $=`${w.first_name||""} ${w.last_name||""}`.trim().toLowerCase(),H=`${B.first_name||""} ${B.last_name||""}`.trim().toLowerCase();return $.localeCompare(H,"ru")});a(L),b(L)}catch{}finally{x(!1)}},R=s=>{const r=s.target.value;_(r)},S=()=>{u(!0),c(!0)},j=s=>{m.current&&!m.current.contains(s.relatedTarget)&&(u(!1),setTimeout(()=>c(!1),200))},N=s=>{const r=s.position?`${s.first_name} • ${s.position}`:s.first_name;_(r),c(!1),u(!1),I(s)};return n.useEffect(()=>{const s=r=>{m.current&&!m.current.contains(r.target)&&(c(!1),u(!1))};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[]),e.jsxs("div",{className:t.searchContainer,ref:m,children:[e.jsx("input",{type:"text",value:l,onChange:R,onFocus:S,onBlur:j,placeholder:"Введите имя, фамилию, тег или номер телефона...",className:t.input}),i&&e.jsx("div",{className:t.loader,children:"Загрузка..."}),p&&f.length>0&&e.jsx("div",{className:t.searchResults,children:f.map(s=>e.jsxs("div",{onClick:()=>N(s),className:t.searchResultItem,onMouseDown:r=>r.preventDefault(),children:[e.jsx("div",{className:t.userName,children:P(s.first_name,s.last_name)}),s.position&&e.jsx("div",{className:t.userPosition,children:s.position})]},s.id))}),p&&!i&&f.length===0&&l.trim()!==""&&e.jsx("div",{className:t.searchResults,children:e.jsx("div",{className:t.noResults,children:"Пользователи не найдены"})})]})}function he({user:d,onBack:I,onTransferSuccess:l}){const[_,h]=n.useState(null),[a,f]=n.useState(""),[b,i]=n.useState(""),[x,y]=n.useState(""),[u,p]=n.useState(!1),c=20;if(!d)return e.jsx(E,{title:"Отправить спасибку",children:e.jsx("div",{className:"loading-container",children:"Загрузка..."})});const m=async g=>{var R,S;if(g.preventDefault(),i(""),y(""),!_||!a){i("Пожалуйста, выберите получателя и напишите сообщение.");return}if(a.trim().length<c){i(`Сообщение должно содержать минимум ${c} символов (включая пробелы и знаки препинания). Сейчас: ${a.length} символов.`);return}p(!0);try{const j={sender_id:d.id,receiver_id:_.id,message:a},N=await T(j);y("Спасибка успешно отправлена!"),h(null),f(""),setTimeout(()=>{l&&l(N.data)},1e3)}catch(j){const N=((S=(R=j.response)==null?void 0:R.data)==null?void 0:S.detail)||"Произошла ошибка.";i(N)}finally{p(!1)}};return e.jsxs(E,{title:"Отправить спасибку",children:[e.jsx("button",{onClick:I,className:t.backButton,children:"← Назад"}),e.jsx("div",{className:t.balanceInfo,children:e.jsxs("p",{children:["Переводов сегодня: ",e.jsxs("strong",{children:[3-d.daily_transfer_count," / 3"]})]})}),e.jsxs("form",{onSubmit:m,children:[e.jsxs("div",{className:t.formGroup,children:[e.jsx("label",{className:t.label,children:"Кому:"}),e.jsx(ae,{currentUser:d,onUserSelect:h})]}),e.jsxs("div",{className:t.formGroup,children:[e.jsx("label",{className:t.label,children:"За что (обязательно):"}),e.jsxs("div",{className:t.textareaContainer,children:[e.jsx("textarea",{value:a,onChange:g=>f(g.target.value),placeholder:"Например, за помощь с отчетом",rows:"3",className:t.textarea}),a.length>0&&e.jsxs("div",{className:t.charCounter,children:[a.length," / ",c]})]}),a.length>0&&a.length<c&&e.jsx("div",{className:t.messageHint,children:e.jsx("span",{className:t.messageHintText,children:"Расскажите подробнее, за что вы благодарны коллеге"})})]}),e.jsx("button",{type:"submit",disabled:u||!_||a.trim().length<c,className:t.submitButton,children:u?"Отправка...":"Отправить спасибку"}),b&&e.jsx("p",{className:t.error,children:b}),x&&e.jsx("p",{className:t.success,children:x})]})]})}export{he as default};
